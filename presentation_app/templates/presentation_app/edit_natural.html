{% extends 'base.html' %}

{% block content %}
<h1>{{ presentation.title }} を編集 (自然言語形式)</h1>

<div class="alert alert-info">
  自然言語で記述した内容から自動的にプレゼンテーションを生成します。<br>
  「スライド: タイトル」のように書くと新しいスライドが作成され、その後に続く文章がそのスライドの内容になります。<br>
  箇条書きには「-」や「・」を使用できます。
</div>

<form method="post">
    {% csrf_token %}
    <div class="form-group mb-3">
        <label for="title">タイトル</label>
        <input type="text" class="form-control" id="title" name="title" value="{{ presentation.title }}" required>
    </div>
    
    {% if template_info.exists %}
    <div class="form-group mb-3">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="use_template" name="use_template" {% if presentation.use_template %}checked{% endif %}>
            <label class="form-check-label" for="use_template">
                テンプレートを使用する ({{ template_info.slide_count }}スライド)
            </label>
        </div>
        <small class="text-muted">テンプレートを使用すると、デザインや配色などのスタイルが適用されます</small>
    </div>
    {% endif %}
    
    <div class="form-group mb-3">
        <label for="content">内容 (自然言語形式)</label>
        <textarea class="form-control" id="content" name="content" rows="15" required>{{ presentation.content }}</textarea>
    </div>
    
    <button type="submit" class="btn btn-primary">保存</button>
    <a href="{% url 'download_pptx' presentation.pk %}" class="btn btn-success">PPTXをダウンロード</a>
</form>

<div class="card mt-4">
    <div class="card-header">
        自然言語からスライドへの変換ガイド
    </div>
    <div class="card-body">
        <h5>基本的な書き方</h5>
        <pre>
スライド: はじめに
このスライドの内容。
複数行書くことができます。

スライド: 箇条書きの例
- 箇条書き項目1
- 箇条書き項目2
- 箇条書き項目3
        </pre>
        
        <h5>その他の書き方</h5>
        <ul>
            <li>「スライド:」や「テーマ:」で始まる行は新しいスライドのタイトルになります</li>
            <li>箇条書きは「-」「・」「*」などで始めることができます</li>
            <li>通常の文章は自動的に文ごとに分割されて箇条書きになります</li>
        </ul>
    </div>
</div>

<div class="natural-preview mt-4">
    <h3>スライド解析プレビュー</h3>
    <div id="preview-area" class="p-3 border">
        <!-- JavaScriptでプレビュー表示 -->
    </div>
</div>

{% block extra_js %}
<script>
    // 自然言語内容の解析プレビュー
    const contentArea = document.getElementById('content');
    const previewArea = document.getElementById('preview-area');
    
    function updatePreview() {
        const content = contentArea.value;
        const slides = parseNaturalLanguage(content);
        
        let previewHtml = '';
        
        // 各スライドを表示
        slides.forEach((slide, index) => {
            previewHtml += `<div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    スライド ${index + 1}: ${slide.title}
                </div>
                <div class="card-body">
                    <ul>`;
            
            // 各ポイントを表示
            slide.points.forEach(point => {
                previewHtml += `<li>${point}</li>`;
            });
            
            previewHtml += `</ul>
                </div>
            </div>`;
        });
        
        previewArea.innerHTML = previewHtml;
    }
    
    // 自然言語をスライドに解析する関数
    function parseNaturalLanguage(content) {
        const slides = [];
        let currentSlide = null;
        
        // 段落で分割
        const paragraphs = content.split('\n\n');
        
        for (const para of paragraphs) {
            const trimmedPara = para.trim();
            if (!trimmedPara) continue;
            
            // 新しいスライドの開始（「スライド:」または「テーマ:」で始まる行）
            if (trimmedPara.toLowerCase().startsWith('スライド:') || 
                trimmedPara.toLowerCase().startsWith('slide:') ||
                trimmedPara.toLowerCase().startsWith('テーマ:') ||
                trimmedPara.toLowerCase().startsWith('theme:')) {
                
                // 前のスライドがあれば追加
                if (currentSlide) {
                    slides.push(currentSlide);
                }
                
                // タイトルを抽出
                const title = trimmedPara.split(':', 1)[1] ? trimmedPara.split(':', 1)[1].trim() : '無題';
                currentSlide = {
                    title: title || '無題',
                    points: []
                };
            }
            // 箇条書きのポイント
            else if (trimmedPara.startsWith('-') || 
                     trimmedPara.startsWith('・') || 
                     trimmedPara.startsWith('*') || 
                     trimmedPara.startsWith('•')) {
                
                if (!currentSlide) {
                    currentSlide = {
                        title: '内容',
                        points: []
                    };
                }
                
                const lines = trimmedPara.split('\n');
                for (const line of lines) {
                    if (line.startsWith('-') || 
                        line.startsWith('・') || 
                        line.startsWith('*') || 
                        line.startsWith('•')) {
                        
                        const point = line.substring(1).trim();
                        if (point) {
                            currentSlide.points.push(point);
                        }
                    }
                }
            }
            // 通常のテキスト
            else {
                if (!currentSlide) {
                    // 最初の段落はタイトルとして扱う
                    currentSlide = {
                        title: trimmedPara,
                        points: []
                    };
                } else {
                    // それ以外は箇条書きとして追加
                    const sentences = trimmedPara.split(/(?<=[。．.!?])\s*/);
                    for (const sentence of sentences) {
                        if (sentence.trim()) {
                            currentSlide.points.push(sentence.trim());
                        }
                    }
                }
            }
        }
        
        // 最後のスライドを追加
        if (currentSlide) {
            slides.push(currentSlide);
        }
        
        return slides;
    }
    
    contentArea.addEventListener('input', updatePreview);
    updatePreview(); // 初期表示
</script>
{% endblock %}
{% endblock %} 